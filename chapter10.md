# 第十章，嵌入式应用开发

本章聚焦于现成的及开源嵌入式开发套件和平台，描述了一些给任何想定制BLE外围设备固件的用户用的工具。

本章第一部分介绍了一个高级别的BLE API，使用ARM的[mbed](http://mbed.org/)开发平台创建并维护。如果你对于嵌入式开发是新手，这是一个很好的选择，因为这不需要你熟悉配置一个嵌入式工具链，或者在底层开发嵌入式硬件。大多数复杂的固件实现问题和设置问题都被简易使用的在线工具和高级别API所掩盖。

第二个部分描述了嵌入式*工具链* ：用于转换标准源代码为运行于嵌入式处理器上的可执行二进制文件工具集。这个部分展示了如何在Windows、OS X或Linux上搭建一个交叉编译工具链环境来编译ARM二进制文件。

本章最后一部分展示实际环境中如何使用这些工具和概念，利用一个在诺迪克的nRF51822片上系统的样例项目，这个项目使用标准心跳配置文件（Heart Rate Profile，关于BLE配置文件请参见第一章[SIG定义的GATT配置文件](./chapter1.md#SIG定义的GATT配置文件)）传输心跳数据给一个iOS或者安卓设备。

![figure-bird](.\pic\figure-bird.png) *样例项目完整代码可在本书[Github目录](http://bit.ly/1qoj8Ed)查看。*

## mbed BLE API

以使用ARM Cortex处理器开发嵌入式硬件更加容易为目标之一，ARM以及合作公司创建了一个开源开发平台[mbed](http://mbed.org/)。mbed上可以编写可移植于各种受支持的ARM处理器的代码，并可以利用运行于这些处理器之上所构建的API和组件。

你也可以免费使用mbed在线合作开发工具和各种脱机商业以及开源工具链和IDE。在定义高级别API上mbed投入了大量的努力，该API抽离了大部分底层芯片中需要花费大量开发负荷的细节。这使得被分享在社区里的开源软件组件可以重复使用，并解放了固件工程师可以更多关注于项目定制的代码，减少在底层围绕微处理器（MCU）的选择实现细节上面的花费。

与本章目标最相关的，ARM近期已经添加了BLE API到mbed平台，该API让你可以使用很少了的代码和几个小时的努力就实现一个简单的带有少量BLE服务和特征的GATT服务端（在第三章[属性和数据层级](./chapter3.md#属性和数据层级)描述），而不需要考虑任何厂商指定的关于栈或者芯片组的细节。

mbed提供了一个将概念验证阶段的产品起步的简单方法，同时可以使用之后转移去生产的平台（必要的话导出代码到脱机编译器）。围绕BLE的高级别的抽象层，意味着你不需要花费大量时间学习关于你的BLE SoC或者模组的细节。例如，一个标准BLE服务或者特征的例子只需要一行代码：

``` java
GattService hrmService(GattService::UUID_HEART_RATE_SERVICE);
GattCharacteristic hrmRate(GattCharacteristic::UUID_HEART_RATE_MEASUREMENT_CHAR,
	2, 3, GattCharacteristic::BLE_GATT_CHAR_PROPERTIES_NOTIFY);
GattCharacteristic hrmLocation
	(GattCharacteristic::UUID_BODY_SENSOR_LOCATION_CHAR,
	1, 1, GattCharacteristic::BLE_GATT_CHAR_PROPERTIES_READ );
```

本文在书写的同时，mbed的BLE API仍处于beta版本，并处于活动开发阶段，但其目前已覆盖了你所需要用于原型和概念验证产品的大多功能。关于mbed或者样例，以及BLE API更新的更多信息，请参考[mbed项目网站](http://mbed.org/)。

## 嵌入式工具链

虽然mbed被作为一个可视化嵌入式开发平台，具有从原型到生产的清晰路径，任何中间厂商的高级别API或者平台都需要在底层实现细节上面失去一些控制。通常你会在代码和驱动中为了一定的底层优化而牺牲易用性。这种权衡在很多情况下都比较合理，但是显然在嵌入式开发中没有一刀切的万全之策。

在产品设计世界中，性能和控制方面经常胜过易用性，许多工程师仍然倾向自己去处理具体的实现，编写自己的底层驱动以及建立自己的编译环境。编写自有的底层驱动很明显需要更多的开发量，但是这也可以确保代码在运行于产品上有着最大的掌控。这也强迫你更理解处理器，以便对性能和消耗进行优化，以达到更高的层次。

嵌入式产品中，在代码大小以及性能进行全面优化是非常重要的。比如，产品可能需要使用一个更小更便宜的处理器，在材料费用上节省$2或者$3花费，这在零售价上很容易转为$5到$10的费用。

