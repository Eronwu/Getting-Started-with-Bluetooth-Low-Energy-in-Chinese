# 第三章节，GAP(广播和连接，Advertising and Connections)

通用访问配置文件（GAP）是BLE设备间相互操作的基础。GAP提供了一个任意一个BLE实现需要遵循的框架，都必须发现各自设备、广播数据、建立安全连接和在一个标准、普遍熟知的方式下执行完成一些其他的基础操作。彻底地了解GAP是非常重要的，因为当提供一个功能性API给应用开发者时，许多BLE协议栈都将其用作最底层入口之一。

就如之前所提到的，BLE核心规格书中GAP章节的部分定义了以下几个设备交互的不同方面：

*角色（Roles）*

​		每一个设备都可以同时操作一个或多个角色。每一个角色都有限制条件并且强制一定的行为要求。一些角色的结合体允许设备相互交流，GAP则在这些角色间精确地建立了交互。虽然并不总是这样，角色倾向于关联特定的设备类型，而且对于大多数（虽然不是全部）实现，角色也会在他们的使用场景下紧密绑定而不作任何改变。

*模式（Modes）*

​		这是更进一步优化角色的概念，模式是设备为了一定量时间获取一个特定的目标的转化的状态，或者更具体来说，允许一端完成一个特定的流程。转换状态可以由用户接口操作或者当被需要时自动地触发，设备比角色更频繁尝试转换角色。

*流程（Procedure）*

​		指一系列允许设备达成某个目标的动作（通常链路层控制流程或数据交换）。一个流程通常和一个其他端的模式关联，因此他们通常一同紧密结合。

*安全性（Security）*

​		GAP在安全管理和安全管理协议的之上，通过定义安全模式、制定端设备如何根据特定的数据交换需求设置安全等级以及之后安全等级如何被强制的这个流程，进行搭建。GAP更进一步定义了额外的与特定的模式或流程毫无联系的安全特征，而且可以自有使用这些以增加数据保护的等级来应对每一个应用的需求。

*附带GAP数据格式*

​		除了以上的几条，GAP也被用来为某些与GAP规格书定义的流程和模式相关的附带信息格式的定义，作为预留。

本章相关部分讲详细调查这些要素。



## 角色

GAP指定了设备采纳并加入一个BLE网络的四种角色：

*广播者（Broadcaster）*

​		为仅负责传输的应用优化数据规律地分发，广播者这个角色定期地发送广播数据包。理论上说，广播者可以被仅带发送器的无线传输模块使用，但实际上，这角色通常被指派给同时拥有发送和接受功能的设备上。读取任意相关设备温度并进行广播的公共温度计就是一个很好的广播者的例子。广播者发送广播包而不是连接数据包，并且数据可以被任何正在监听（listen）的设备访问。广播者（broadcaster）角色使用链路层广播者（advertiser）的角色。

*观察者（Observer）*

​		为仅接收、尝试从广播设备手机数据的应用优化，观察者监听那些来自广播端的广播包内的数据。带有显示器的设备通常是这个角色的典型应用，比如显示从只广播数据的温度传感器得到的温度数据的平板电脑。观察者（observer）角色使用链路层扫描者（scanner）的角色。

*中心设备（Central）*

​		中心角色与链路层主机相一致。中心设备可以与大量端设备建立连接，并总是为连接的发起者，本质上允许设备连上网络。BLE是非对称的协议，这意味着链路层主机的计算需求大大高于链路层从机。通常在网络中，智能手机或者平板扮演中心设备这个角色，因为它们拥有强大的CPU和内存资源，这一点也能够使得与大量设备能够保持连接。中心设备通过监听获取其他设备的广播包，接着对一个已选的设备发起连接。在单一网络中，这个过程可以对大量设备重复执行。

*外围设备（peripheral）*

​		外围设备角色与链路层从机一致。这个角色使用发送广播包方式让中心设备发现，接着下一步就是与之建立连接。BLE协议对外围设备的资源要求不多，至少从CPU和内存角度来说。这为价格优廉的BLE外围设备市场铺了很好的一条道路。

每一个特定的设备都可以一个或多个角色同时操作，规格书在这一点没有强加限制。

许多开发者错误地将GAP角色与BLE GATT*客户端* 和*服务端* 尝试关联。在这两之间并没有任何连接，任何设备都可以根据应用和场景作为一个GATT客户端、服务端，或者同时为两者。

细想，如一个健康追踪器与智能手机相匹配的例子。健康追踪器的GAP角色是外围设备，当手机要求从追踪器的传感器上获取数据时，追踪器是作为一个GATT服务端的。当追踪器需要更新内部时钟为数据增加时间戳，而要求从手机获取精准时间，这时候追踪器就是作为一个GATT客户端。GATT客户端/服务端的角色唯独取决于数据需求和回应事务流程的方向，反之GAP角色总是不变，健康追踪器为外围设备而智能手机为中心设备。

### 模式和流程

表3-1展示了GAP模式和应用的流程（没有一个初始与之对应的流程则标记为"N/A"）。

*表3-1. 模式和应用的流程*

| 模式                                   | 应用角色                 | 应用端流程                                          |
| -------------------------------------- | ------------------------ | --------------------------------------------------- |
| 广播（Broadcast）                      | 广播者                   | 观察（Observation）                                 |
| 不可发现（Non-discoverable）           | 外围设备                 | N/A                                                 |
| 有限制的可发现（Limited discoverable） | 外围设备                 | 有限制及普通的发现（Limited and General discovery） |
| 普通的可发现（General discoverable）   | 外围设备                 | 普通的发现（General discovery）                     |
| 不可连接的（Non-connectable）          | 外围设备，广播者，观察者 | N/A                                                 |
| 任何可连接的（Any-connectable）        | 外围设备                 | 任何连接建立（Any connection establishment）        |



相反地，表3-2展示了需要完成罗列的GAP流程列表的端设备的模式。

*表3-2. 流程和其要求的模式*

| 流程                                         | 应用角色           | 应用端模式                                               |
| -------------------------------------------- | ------------------ | -------------------------------------------------------- |
| 观察（Observation）                          | 观察者             | 广播（Broadcast）                                        |
| 有限制的发现（Limited discovery）            | 中心设备           | 有限制的可发现（Limited discoverable）                   |
| 普通的发现（General discovery）              | 中心设备           | 有限制及普通的可发现（Limited and General discoverable） |
| 指定的发现（Name discovery）                 | 外围设备，中心设备 | N/A                                                      |
| 任何连接建立（Any connection establishment） | 中心设备           | 任何可连接（Any connectable）                            |
| 连接参数更新（Connection parameter update）  | 外围设备，中心设备 | N/A                                                      |
| 终止连接（Teminate connection）              | 外围设备，中心设备 | N/A                                                      |

[第一章](./chapter1.md)和[第二章](./chapter2.md)介绍了BLE中隔空数据交互的基本概念，在这里可以值得简要地回顾一番。广播包无方向地按照固定间隔时间盲目发送，这建立了广播(broadcasting)（和观察 observing）和发现(discovery)的基础。一个正扫描广播包的设备可能收到一个正处于传输中的广播包，这可能仅仅时接收数据，或者开始发起连接。*连接(Connections)* ,另一方面来说，要求两端在定期地时间间隔下同步完成数据交互，并在数据传输和吞吐中提供保证。

### 广播和观察

GAP中定义的广播模式和观察流程建立了一套设备可以无方向地发送数据的框架，即作为一个*(广播者 broadcaster)* 发送给一个或多个活动中的处于监听的端设备（*观察者 observers*）。很重要一点是，广播者没有办法了解数据是否到达任何观察者，因此模式和流程的结合对这术语保持了可信度：广播者无需任何确认(confirmation)或应答(acknowledgement)即可广播数据，观察者监听（暂时或者无限期）潜在的广播者也无需任何接收的数据的保证。

广播者发送的广播包包含了实际有效的用户数据，包含了链接层插入的一些元素据信息（metadata, 如蓝牙设备地址）。第二章的[广播和扫描](./chapter2.md#广播和扫描)有进行描述，每一个广播包都包含至多31字节的数据（实际可用的用户数据长度将会更低，因为有包头和格式的耗用），但这一点也不一定，当通过使用扫描请求/扫描回应交互，在成功接收到观察者的广播包之后，是可产生至多每个广播事件62字节的数据。因为一个扫描回应包仅由观察者的请求而发送，最要紧的数据总是被放置到广播包自身，而不是在扫描回应包。广播者可以发送ADV_NONCONN_IND 或 ADV_SCAN_IND 广播包（见第二章[表2-1](./chapter2.md#广播和扫描)）。

通过创建一个仅广播者的设备，你可以简单地将数据广播到外界，任何处于监听范围内的设备都可以接收，无论是一台还是一百台设备。这一点明显对比*外围设备*，其在建立一个连接之后就停止了自身的广播，并有效关闭了对监听范围内的其他中心设备的连接通道，直到该连接关闭，或者一种少见的情况，设备作为从机可以支持大量连接，直到一个另外的连接被创建。

如苹果的iBeacon（请见后文[iBeacon](#iBeacon)）使用广播模式不停向外发送一个在广播数据中的厂商指定数据区域的负载数据，以允许任何监听范围内的设备无需完全访问即可发现iBeacon设备。iBeacon结点无需担心多少设备正在监听，它只需要保持告知外界设备在这里，并交互有限的负载数据给那些关注监听的设备。

### 发现

设备的*可发现性（discoverability）*指外围设备如何向其他设备广播自身的存在，以及那些设备可以或者应该怎样处理这些信息。不同可发现模式的区别与发现流程是关系到广播和扫描是否实际上执行完成并且考虑到广播包内数据的属性。更准确地说，一个SIG定义的广播数据的可选区域，称为*Flags AD* 掌控了设备的可发现模式（见表3-3）。

这些模式仅被外围设备使用，这使得中心设备在自己的监听范围内可以发现这些外围设备。*发现（Discovery）*大体上指监测周围出现的设备以及其基本信息。这并不意味着有必要建立一个连接或者数据交互，尽管大部分情况是这样。在某些情况下，尤其是中心设备装有用户可见的显示屏幕， 发现功能就会被用作产生一组附近的设备从而用户可以选择进行连接。

#### 可发现性模式

以下可发现性模式(discoverability mode)可以根据设计优先级（电量、快速连接时间等）提供给外围设备设计师一定数量的灵活性：

*不可发现模式(non-discoverable mode)*

​		不被发现意味着其他设备无法知道外围设备的存在与否，或者询问到它们的属性。这个模式通常用于当设备完全不想被中心设备搜索到，无论是要建立连接还是仅被监测。处在这模式的设备仍然可以发送广播，但这种情况下设备必须清楚广播数据的Flags AD段中通用和受限制的标志位。当确定选择发送广播包，那这必须是ADV_NONCONN_IND 或者 ADV_SCAN_IND类型（见第二章[表2-1](./chapter2.md#广播和扫描)）。

*受限可被发现模式(Limited discoverable mode)*

​		该模式允许设备在一定时间内可被发现，同时优先级相对较低。此模式的设备发送的广播包在Flags AD段设置了受限制可被发现的标志位（见[表3-3](#表3-3)）。执行受限制发现流程的中心设备将可监测到仅在此模式的设备。该模式的热度已经逐年递减，如今的趋势是当被需要的时候使用带特有过滤器的通用可发现模式。

*通用可发现模式(General discoverable mode)*

​		该模式使设备可发现时间可以按照需求开启足够长久。开启该模式的设备表达出被中心端发现的强烈渴望，通常也有建立连接的目的。当发送广播时设备需要在广播包的Flags AD段中设置通用可发现标志位，才可以使用该模式（见[表3-3](#表3-3)。只有中心设备执行通用发现流程才可以找到该模式的外围设备。

外围设备自工厂出厂，在绑定一个中心设备之前通常是可被发现模式，但在初始绑定流程之后就会进入不可发现模式，以未来唯独与该中心设备连接。这种情况下，重置回工厂默认状态通常就会回到可被发现模式。

#### 发现流程

规格书提供了两种发现流程(discovery procedures)：

*受限发现流程（Limited discovery procedure）*

​		执行该流程的中心设备开启扫描不带白名单（见第二章[白名单](./chapter2.md#白名单)）过滤的广播者并分析每一个收到的广播包。如果已设置受限可被发现标志位，端设备信息就会被发送给应用以应对更进一步的行动。

*通用发现流程（General discovery procedures）*

​		执行该流程的中心设备开启扫描不带白名单（见第二章[白名单](./chapter2.md#白名单)）过滤的广播者并分析每一个收到的广播包。如果已设置受限可被发现标志位或者通用可被发现标志位，端设备信息就会被发送给应用以应对更进一步的行动。

换句话说，搜寻所有可被发现的端设备的设备应该选择通用发现流程。使用受限发现流程是为了仅发现受限可发现模式的设备。

### 连接建立

中心设备发起建立与外围设备的连接，后者必须处于*可连接* 的模式。与发现相同，模式和流程在组织和标准化样式下控制了设备与之交互的选项。

#### 连接建立模式

以下连接建立模式（Connection establishment mode）之间的差别反映出外围设备对广播包的不同类型的使用（详尽参阅第二章[广播和扫描](./chapter2.md#广播和扫描)）：

*不可连接模式（Non-connectable mode）*

​		处于这种模式的设备要么不发送广播包，要么只发送ADV_NONCONN_IND 或 ADV_SCAN_IND广播包（见第二章[表2-1](./chapter2.md#广播和扫描)）。在这两种情况下，设备就如该模式名字一样，不可连接，这意味着没有中心设备可以与之建立连接。

*直连可连接模式（Directed connectable mode）*

​		处于这种模式的设备发送ADV_DIRECT_IND广播包（见第二章[表2-1](./chapter2.md#广播和扫描)）。当执行直接广播发送，设备在高频率下短时间发送没有用户数据负载但带有目标中心设备蓝牙地址的广播包。当外围设备已经启动过连接并想以最快速度建立连接时，这种被作为“快速重连（fast reconnect）”的模式通常就会被使用。仅当蓝牙地址与外围设备发送的广播包内的信息相匹配的中心设备才可以接收到这些信广播包。

*非直连可连接模式（Undirected connectable mode）*

​		处于该模式的设备发送ADV_IND广播包（见第二章[表2-1](./chapter2.md#广播和扫描)）。这是标准可连接模式，即外围设备使自己在较长的一段时间可连接，并尝试连接新的中心设备或者之前已经连接过的已知设备。

以上两个可连接模式都有隐性要求，设备需要发送带有连接中心设备目的的广播包。

#### 连接建立流程

当中心设备扫描尝试进行连接时，因为没有对将要接收的广播包进行类型选择（广播包将总是ADV_IND 或 ADV_DIRECT_IND类型），连接建立流程之间的区别就不依赖于广播包的类型。取而代之的是，连接建立流程的类型依赖于中心设备对以下接收的数据包的类型过滤：

*自动连接建立流程（Auto connection establishment procedure）*

​		该流程为单步执行流程，主机产生一组已知外围设备的白名单（见第二章[白名单](./chapter2.md#白名单)），接着指示控制器连接第一个监测到的设备。一般而言，当中心设备已经知道一组一定数量的设备并没有任何连接偏好，这种流程是最实用的。

*通用连接建立流程（General connection establishment procedure）*

​		该流程为双步执行流程，通常用于连接新的未知的外围设备。中心设备无需白名单的条件下进行扫描，并接收所有发来的所有的广播包。对于每一个监测到的外围设备，应用需要决定连接哪一个还继续扫描下一个。如此，应用就可以显示给用户信息或者拆解接收到的广播包内的广播数据。一旦选择了外围设备，中心设备就将使用直连连接建立流程进行连接。

*可选择的连接建立流程（Selective connection establishment procedure）*

​		该流程除了主机使用一组已知设备的白名单进行过滤接收的广播包外，其他与通用连接建立流程完全相同。当用户需要选择一组已知的外围设备进行连接时，这种流程最为实用。

*直连连接建立流程（Direct connection establishment procedure）*

​		这个是标准单步连接建立流程，将中心设备与一个独有的外围设备进行连接。主机使用链接层与一个单独设备发动连接，通过自身蓝牙地址进行辨认而不需要事先了解是否存在。该流程如果在外围设备并不可用或者非可连接模式下，会导致失败。

这里再重复表述下，中心设备主机有着两种不同的启动连接的方式。第一种需要两个步骤：受限扫描，接着直接连接一个再扫描中监测到的设备（通过特定的蓝牙地址）。第二个方法跳过了明确的扫描步骤，取而代之是使用控制器选择一个或者多个设备进行连接，而不需要事先了解是否这些设备在附近。

### 附加的GAP流程



