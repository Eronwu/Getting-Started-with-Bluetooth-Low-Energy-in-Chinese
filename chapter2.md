# 第二章节，基本协议

虽然用户总是仅仅直接与BLE协议栈的上层接口进行交互，但最好是对整个栈开始有一个基本的概观，了解这个栈提供了一个可靠的基础来更好理解这些东西是如何操作以及原因。

正如图2-1展示，一个完整的单模BLE设备被分为三块：控制器（controller）、主机（host）和应用（application）。

*应用*

​		就像其他类型的系统一样，应用是在最高层，负责了逻辑、用户接口，以及所有与应用实现的实际用例相关的数据处理。一个应用的结构设计高度依赖于每一个特殊的实现。

*主机*

​		包含了以下层：

				- 通用访问配置文件 Generic Access Profile（GAP）
				- 通用属性配置文件 Generic Attribute Profile（GATT）
				- 逻辑链路控制和适配协议 Logical Link Control and Adaption Protocol （L2CAP）
				- 属性协议 Attribute Protocol（ATT）
				- 安全管理 Security Manager（SM）
				- 主机控制器接口 Host Controller Interface（HCI），主机端

*控制器*

​		包含了以下层：

		- 主机控制器接口 Host Controller Interface（HCI），控制器端
		- 链路层 Link Layer（LL）
		- 物理层 Physical Layer（PHY）

在这一章，各部分的顺序将会从下（天线 antenna）到上（用户接口 user interface）以介绍不同的部分的方式，来组成一个BLE设备。

![figure2-1](./pic/figure2-1.png)

*图2-1. BLE协议栈*

## 物理层

物理层（PHY）是实际包含了模拟通信电路、调制解调和转化为电信号的能力。

无线通信模块使用了2.4Ghz ISM（工业Industrial、科学Scientific和医疗Medical）频段进行交流，并将2.4000GHz到2.4835Ghz的频段分割成40个信道（channels）。如图2-2，37个信道被用作数据连接，剩下3个信道（37、38、39）被用在广播信道上，用于建立连接和发送广播数据。

![figure2-2](./pic/figure2-2.png)

*图2-2. 频段*

这个标准使用了一个技术叫做：*调频技术 Frequency-Hopping Spread Spectrum*， 无线电使用下面的这个公式，在每一个连接事件中，在频段之间跳转：

​		*信道 = （当前信道 + 跳转）取余 37 （ 原文：channel = (curr_channel + hop) mod 37 ）*

当连接建立好之后，经过通信而取得跳变的值，因此，每一次的连接该值都是不同的。这项技术大大减小了在2.4GHz频段中，通过单独一个信道下无线电干扰的可能的影响，尤其是因为在这个波段中WiFi和经典蓝牙的流行，在接近到高传输功率的其他设备下，设备可能遇到很严重的干扰。

高斯频移键控（Gaussian Frequency Shift Keying, GFSK）是指在空气中选择对码流的调制，同样的调制被使用在经典蓝牙和许多其他专有的低功耗无线协议。BLE的调制速率被固定在1Mbit/s，因此上层物理吞吐量就因为这个技术被限制。

![figure2-2-plus](./pic/figure2-2-plus.png)   *实际上，正如任何其他协议栈，当说到应用数据吞吐量，永远难以实际达到上层的极限，主要就因为在不同层上的各种协议。*

## 链路层

链路层是与PHY直接连接的部分，通常被作为软硬件定制的结合体实现。这个也是整个协议栈中唯一的硬实时约束层，因为对于遵守规格书中定义的所有时序要求，链路层是负责任的。因此它经常被依靠隐藏着来自其他层（参照后文[主机控制器接口（HCI）](#主机控制器接口（HCI）)）复杂、实时的需求的标准接口的高层协议栈部分所孤立。

硅厂商在硬件中通常实现从计算上来讲的昂贵、简易自动化的功能，以避免CPU在运行栈中所有的软件层会过载。这些功能通常包括：

- 前同步码（Preamble），访问地址（Access Address）和空中协议框架（air protocol framing）
- CRC生成和校验（CRC generation and verification）
- 数据白化（Data whitening）
- 随机码生成（Random number generation）
- AES加密（AES encryption）

链路层的一半软件部分管理着无线模块的链路状态，即设备如何与其他设备连接。一个BLE设备可以根据使用场景和要求作为一个主机（master），一个从机（slave），或者同时作为主机从机。启动连接的设备将成为主机和从机，对他们的可获得性进行广播，接受连接的将成为从机。

一个主机可以与大量从机进行连接，一个从机也可以与许多主机进行连接。通常，如智能手机或者平板的设备更趋于作为主机，而较小、简单、容量受限的设备，如独立运行的传感器常作为从机角色。

BLE在主机从机间，较低的层固有一个不对称性，因为主机需要更多的资源。这个不对称性与USB相似，USB主机相比USB设备需要更多的资源。这种结构上不对称性的类型允许廉价的外围设备在便宜的微控制器上运行，而底层协议的多数复杂性则出现在有更多资源的设备上，如智能手机和平板。

链路层定义了以下角色：

*广播者（Advertiser）*

​		发送广播数据包的设备。

*扫描者（Scanner）*

​		扫描广播数据包的设备。

*主机（Master）*

​		启动连接并且之后进行管理的设备。

*从机（Slave）*

​		接受连接请求并遵循主机时序的设备。

这些角色被有条理地组织成为两对：广播者和扫描者（当没有处在一个活动连接）以及主机和从机（当处在一个连接中）。

## 蓝牙设备地址

