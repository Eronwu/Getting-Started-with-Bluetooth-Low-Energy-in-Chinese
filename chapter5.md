# 硬件平台

大多数对于BLE可用的产品的商业用例包含了从设备，而不是你可能设计与之交互的主设备（手机、平板或者个人电脑）。如上，本章将介绍一些特定的开发平台用于设计和制作BLE从设备的原型。

本章讨论的内容假设了一个熟悉嵌入式系统设计（[第十章](#./chapter10.md)），并主要目标是给产品设计师指出一个便宜、与他们的产品合适且易于使用的平台。

## nRF51822-EK(Nordic Semiconductor，诺迪克半导体公司)

诺迪克半导体多年来一直致力于低功耗无线解决方案，并作为蓝牙SIG组织的董事会成员，自BLE起初开始就帮助进行BLE标准的制定和完型。众所周知，在无线市场中诺迪克的流行是因为通用无线射频（RF）硅芯片解决方案，这是市面上第一个将BLE从机模式的硅芯片引入市场并使其可负担得起的公司。诺迪克最新的nRF51家族代表了一个从以往多种单芯片RF产品的完整再设计方案，集成了一个带着现代32位ARM微处理器的无线模块在一颗单独的芯片当中。

### 技术规格书

诺迪克的nRF51系列使一个高度整合的片上系统，集成了一个BLE无线模块和一个现代ARM处理器以及下列特征在单独一颗低成本套装中：

- ARMCortex-M0核，运行在16Mhz的频率
- 128或者256KB flash内存（在80到90KB间被用于作S110 BLE栈）
- 16KB SRAM（8KB可供应用包括S110 BLE栈使用）

对于不同产品设计师，作为一个完全以flash为基础的设备是一个区分nRF51822的关键因素。这意味着BLE栈被写入到可修改的flash内存中，并可以作为核心规格书更新内容，而不需要新的硅芯片升级。

这种方式的不利因素为增加了许多附带的制造成本，相比一个以ROM为基础的解决方案。但是蓝牙核心规格书给的这个快捷开发方式，在长期看是利大于弊，因为这种方式让诺迪克相比其他选择了耕地成本的ROM为基础的芯片的硅厂商，能用最新的规格书用更快的速度更新推向市场。

### 软设备架构

为了在其芯片实现BLE支持（芯片也可以给非BLE标准使用，如作为ANT+和4.2GHz协议），诺迪克使用了一个叫做*软设备（SoftDevice, SD）*的东西。软设备本质上就是一个位于flash内存的底部的黑盒子，实现如BLE协议栈和从设备角色支持的特性。用户（应用）代码位于flash内存的一个更高的地址位，这样调用低层次的软设备更合适。

许多BLE产品使用S110软设备，该软设备仅为从机解决方案。该设备架构也包括一个支持主设备角色的S120软设备，但因为对于BLE方面用例很少相同，本小节的讨论就将专注于S110。

诺迪克的软设备设计处理有自身的优缺点。有点为，有一个以软设备形式存在的分离的、认证的、可信赖的BLE协议栈允许固件开发工程师用更多精力专注于应用层的代码。他们可以用尽量少的API、如GAP（[第三章](./chapter3.md)）和GATT（[第四章](./chapter4.md)）的更高层级概念进行处理，而不用管底层软设备的细节（安全实现、信息校验等）。

软设备也允许固件开发工程师避免处理自身的无线配置，这个是在大多RF产品中，固件开发流程中很重要的一个部分。将这些细节放入黑盒子中可以保护固件开发工程师免于受到底层错误的干扰，并先煮简化了产品核验的流程，因为底层BLE代码要依照蓝牙核心规格书才能保证进行功能实现。

软设备其他的优点为，其允许了一个硬件设计为支持多种无线协议或者用例，包括设计为一个通用协议的能力，这将大大减小了公司内部基于同一个PCB设计的多个相似产品的生产成本。

最后，软设备的架构对于应用开发者是没有干扰的。因为软设备独立运行并且应用不需要链接任何库，包括SD和应用升级都可以单独无依赖条件下进行，在很大程度上，可以独立地升级一个Linux内核或者用户空间的库，而不需要担心另一方面被升级影响。

缺点方面，软设备要求的系统资源将不可以被自有应用使用。S110软设备分配了flash底部80KB和SRAM8KB的大小空间，留下176KB的flash空间和8KB的SRAM空间给应用使用（假设正在使用256KB版本的nRF51822）。

软设备设计也引入了延迟和架构限制，比如高层代码需要调用底层软色号被的代码，这需要通过ARM核的软件中断来进行。

作为任何大的开发任务，软设备带来的大量有点也带来了一些牺牲，大多数围绕时序和硬实时需求。

### 用nRF51822-EK工作

如果你对nRF51822的评估感兴趣，最好的开始的平台就是诺迪克的nRF51822-EK，如图5-1所示，该评估套件包含了两个开发板：PCA10001（如图左）和PCA10000（如图右）。

![figure5-1](.\pic\figure5-1.png)

*图5-1. 诺迪克半导体的nRF51822-EK*

PCA10000是一个很小的USB适配器（USB dongle），主要用于调试，通过诺迪克主控制平台或者一个嗅探器（sniffer）模拟一个中心设备去推送数据到Wireshark软件（在[第七章](./chapter7.md)进行介绍）。但这也是一个完整功能的开发板，整合了一个可以通过大量开发工具进行编程和调试固件的Segger的J-Link。

比较大的PCA10001是一个套件中的主开发板。其将nRF51822上可用的pin脚都分离出来，你可以连接I2C或SPI的传感器或者从设备，通过UART于其他设备进行交互等。开发板上也包含了一个J-Link用于编程和调试MCU，还有一些其余的电路去测量功耗，这使得调试和制作原型更为简单。比如UART输出可通过USB直连出去，因此可以更直观调试信息或者发送简单的命令给MCU。开发板还有一个CR2032的电池口，使开发板可以由一个很小的电池驱动。

### 例子和工具链

诺迪克提供了基于该开发套件的大量例子（在注册玩你的套件之后，见本段的提示），如果刚开始进行你所知道的事物进行开发，这是一个很容易的选择。大多演示代码使用Keil's vVision（IAR工具链作为第二选项），这对于一个ARM的非商业的使用在小于32KB的项目上面是自由使用的（32KB实际上只包括了项目的范围，因为软设备不包含在这32KB的限制中，只有应用代码）。

![warning](.\pic\figure-bird.png) *你需要在[诺迪克半导体网站](http://www.nordicsemi.com/)上创建一个我的页面账户，并在你可以访问最新的演示代码和该芯片组的开发工具前，给你的nRF51822-EK注册一个序列号。*

一些支持的工具和样例项目也可以给GNU类的工具使用，虽然GNU（以及Eclipse）支持不如Keil uVision强大。但是在GNU/Linux和Mac OS X上开发完整的应用而不需要凭借Windows是没意义的。

为提供一个开源的选项，本书也包括了一个基本代码放在了[GitHub](https://github.com/microbuilder/nRF51822_GNU)上。该代码基于一个自由可用的GNU工具链，包括了makefiles, 启动代码和一些基本工具用板子上的J-Link调试器来编程写入flash中。

## CC2541DK-MINI(Texas Instruments，德州仪器)

